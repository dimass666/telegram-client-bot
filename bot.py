import telebot
from telebot import types
from database import (
    init_db, add_client, get_client_by_identifier,
    update_client_field, delete_client_by_id
)
from datetime import datetime, timedelta

bot = telebot.TeleBot("7636123092:AAEAnU8iuShy7UHjH2cwzt1vRA-Pl3e3od8")
admin_id = 350902460
client_data = {}

main_menu = types.ReplyKeyboardMarkup(resize_keyboard=True)
main_menu.row("‚ûï –î–æ–±–∞–≤–∏—Ç—å", "üîç –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞")

def clear_chat(chat_id):
    try:
        messages = bot.get_chat_history(chat_id, limit=20)
        for msg in messages:
            try:
                bot.delete_message(chat_id, msg.message_id)
            except:
                continue
    except:
        pass

@bot.message_handler(commands=['start'])
def start(message):
    if message.from_user.id != admin_id:
        return bot.send_message(message.chat.id, "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
    bot.send_message(message.chat.id, "CRM –¥–ª—è PS –∫–ª–∏–µ–Ω—Ç–æ–≤", reply_markup=main_menu)

@bot.message_handler(func=lambda m: m.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å")
def start_add(message):
    if message.from_user.id != admin_id:
        return
    client_data.clear()
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", "Telegram", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–®–∞–≥ 1: –£–∫–∞–∂–∏—Ç–µ —Å–ø–æ—Å–æ–± –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞", reply_markup=markup)
    bot.register_next_step_handler(message, get_identifier)

def get_identifier(message):
    if message.text == "–û—Ç–º–µ–Ω–∞":
        clear_chat(message.chat.id)
        return
    client_data["method"] = message.text
    bot.send_message(message.chat.id, f"–í–≤–µ–¥–∏—Ç–µ {message.text.lower()}:")
    bot.register_next_step_handler(message, ask_birth_option)

def ask_birth_option(message):
    client_data["username"] = message.text.strip()
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("–ï—Å—Ç—å", "–ù–µ—Ç—É", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–®–∞–≥ 2: –ï—Å—Ç—å –ª–∏ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è?", reply_markup=markup)
    bot.register_next_step_handler(message, ask_birth_date)

def ask_birth_date(message):
    if message.text == "–û—Ç–º–µ–Ω–∞":
        clear_chat(message.chat.id)
        return
    if message.text == "–ï—Å—Ç—å":
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):")
        bot.register_next_step_handler(message, collect_birth_date)
    else:
        client_data["birth_date"] = "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        ask_account_info(message)

def collect_birth_date(message):
    try:
        datetime.strptime(message.text.strip(), "%d.%m.%Y")
        client_data["birth_date"] = message.text.strip()
    except:
        client_data["birth_date"] = "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
    ask_account_info(message)

def ask_account_info(message):
    bot.send_message(message.chat.id, "–®–∞–≥ 3: –í–≤–µ–¥–∏—Ç–µ:\nemail\n–ø–∞—Ä–æ–ª—å\n–ø–∞—Ä–æ–ª—å –æ—Ç –ø–æ—á—Ç—ã (–º–æ–∂–Ω–æ –ø—É—Å—Ç–æ)")
    bot.register_next_step_handler(message, process_account_info)

def process_account_info(message):
    lines = message.text.strip().split('\n')
    email = lines[0] if len(lines) > 0 else ""
    password = lines[1] if len(lines) > 1 else ""
    mail_pass = lines[2] if len(lines) > 2 else ""
    client_data["email"] = email
    client_data["account_password"] = f"{email};{password}"
    client_data["mail_password"] = mail_pass
    ask_reserve_code(message)

def ask_reserve_code(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("–î–∞", "–ù–µ—Ç", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–®–∞–≥ 4: –ï—Å—Ç—å –ª–∏ —Ä–µ–∑–µ—Ä–≤ –∫–æ–¥—ã?", reply_markup=markup)
    bot.register_next_step_handler(message, process_reserve_code)

def process_reserve_code(message):
    if message.text == "–û—Ç–º–µ–Ω–∞":
        clear_chat(message.chat.id)
        return
    if message.text == "–î–∞":
        bot.send_message(message.chat.id, "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å —Ä–µ–∑–µ—Ä–≤ –∫–æ–¥–∞–º–∏ (–æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)")
        bot.register_next_step_handler(message, save_reserve_photo, content_types=['photo'])
    else:
        client_data["reserve_photo"] = None
        ask_subscription_status(message)

def save_reserve_photo(message):
    if not message.photo:
        bot.send_message(message.chat.id, "–≠—Ç–æ –Ω–µ —Ñ–æ—Ç–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.")
        return bot.register_next_step_handler(message, save_reserve_photo, content_types=['photo'])
    file_id = message.photo[-1].file_id
    client_data["reserve_photo"] = file_id
    ask_subscription_status(message)
    def ask_subscription_status(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("–î–∞", "–ù–µ—Ç", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–®–∞–≥ 5: –û—Ñ–æ—Ä–º–ª–µ–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞?", reply_markup=markup)
    bot.register_next_step_handler(message, ask_subscriptions_count)

def ask_subscriptions_count(message):
    if message.text == "–û—Ç–º–µ–Ω–∞":
        clear_chat(message.chat.id)
        return
    if message.text == "–ù–µ—Ç":
        client_data["subscription_name"] = "–ù–µ—Ç—É"
        client_data["subscription_start"] = ""
        client_data["subscription_end"] = ""
        client_data["region"] = ""
        ask_games_option(message)
    else:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add("–û–¥–Ω–∞", "–î–≤–µ", "–û—Ç–º–µ–Ω–∞")
        bot.send_message(message.chat.id, "–°–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ?", reply_markup=markup)
        bot.register_next_step_handler(message, choose_first_subscription)

def choose_first_subscription(message):
    if message.text == "–û—Ç–º–µ–Ω–∞":
        clear_chat(message.chat.id)
        return
    client_data["subs_total"] = message.text
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential", "EA Play")
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É:", reply_markup=markup)
    bot.register_next_step_handler(message, collect_first_subscription)

def collect_first_subscription(message):
    client_data["sub1_type"] = message.text
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("12–º", "3–º", "1–º", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–°—Ä–æ–∫ –ø–µ—Ä–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=markup)
    bot.register_next_step_handler(message, collect_first_duration)

def collect_first_duration(message):
    client_data["sub1_duration"] = message.text
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("(—É–∫—Ä)", "(—Ç—É—Ä)", "(–¥—Ä—É–≥–æ–µ)")
    bot.send_message(message.chat.id, "–†–µ–≥–∏–æ–Ω –ø–µ—Ä–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=markup)
    bot.register_next_step_handler(message, collect_first_region)

def collect_first_region(message):
    client_data["sub1_region"] = message.text
    bot.send_message(message.chat.id, "–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–¥.–º–º.–≥–≥–≥–≥):")
    bot.register_next_step_handler(message, calculate_subscriptions)

def calculate_subscriptions(message):
    try:
        start = datetime.strptime(message.text, "%d.%m.%Y")
    except:
        start = datetime.now()
    client_data["subscription_start"] = start.strftime("%d.%m.%Y")
    duration = client_data["sub1_duration"]
    end = start + (timedelta(days=365) if duration == "12–º" else timedelta(days=90) if duration == "3–º" else timedelta(days=30))
    client_data["subscription_end"] = end.strftime("%d.%m.%Y")
    client_data["region"] = client_data["sub1_region"]
    client_data["subscription_name"] = f"{client_data['sub1_type']} {client_data['sub1_duration']} {client_data['sub1_region']}"

    if client_data.get("subs_total") == "–î–≤–µ":
        second = ["EA Play"] if "PS Plus" in client_data["sub1_type"] else ["PS Plus Deluxe", "PS Plus Extra", "PS Plus Essential"]
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        for s in second:
            markup.add(s)
        bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É:", reply_markup=markup)
        bot.register_next_step_handler(message, add_second_subscription)
    else:
        ask_games_option(message)

def add_second_subscription(message):
    client_data["sub2_type"] = message.text
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("12–º", "3–º", "1–º", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–°—Ä–æ–∫ –≤—Ç–æ—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:", reply_markup=markup)
    bot.register_next_step_handler(message, second_sub_duration)

def second_sub_duration(message):
    client_data["sub2_duration"] = message.text
    bot.send_message(message.chat.id, "–†–µ–≥–∏–æ–Ω –≤—Ç–æ—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:")
    bot.register_next_step_handler(message, second_sub_region)

def second_sub_region(message):
    client_data["sub2_region"] = message.text
    bot.send_message(message.chat.id, "–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–¥.–º–º.–≥–≥–≥–≥):")
    bot.register_next_step_handler(message, complete_subscription_info)

def complete_subscription_info(message):
    try:
        start = datetime.strptime(message.text, "%d.%m.%Y")
    except:
        start = datetime.now()
    duration = client_data["sub2_duration"]
    end = start + (timedelta(days=365) if duration == "12–º" else timedelta(days=90) if duration == "3–º" else timedelta(days=30))
    sub1 = f"{client_data['sub1_type']} {client_data['sub1_duration']} {client_data['sub1_region']}"
    sub2 = f"{client_data['sub2_type']} {client_data['sub2_duration']} {client_data['sub2_region']}"
    client_data["subscription_name"] = f"{sub1} + {sub2}"
    client_data["region"] = f"{client_data['sub1_region']}, {client_data['sub2_region']}"
    client_data["subscription_end"] = end.strftime("%d.%m.%Y")
    ask_games_option(message)

def ask_games_option(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("–î–∞", "–ù–µ—Ç", "–û—Ç–º–µ–Ω–∞")
    bot.send_message(message.chat.id, "–®–∞–≥ 6: –ï—Å—Ç—å –ª–∏ –∏–≥—Ä—ã —É –∫–ª–∏–µ–Ω—Ç–∞?", reply_markup=markup)
    bot.register_next_step_handler(message, collect_games)

def collect_games(message):
    if message.text == "–ù–µ—Ç":
        client_data["games"] = ""
        finish_add(message)
    elif message.text == "–î–∞":
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä (–ø–æ —Å—Ç—Ä–æ–∫–∞–º):")
        bot.register_next_step_handler(message, save_games)
    else:
        clear_chat(message.chat.id)

def save_games(message):
    games = message.text.split('\n')
    client_data["games"] = " ‚Äî‚Äî ".join(games)
    finish_add(message)

def finish_add(message):
    data = (
        client_data.get("username", ""),
        client_data.get("birth_date", ""),
        client_data.get("email", ""),
        client_data.get("account_password", ""),
        client_data.get("mail_password", ""),
        client_data.get("subscription_name", "–ù–µ—Ç—É"),
        client_data.get("subscription_start", ""),
        client_data.get("subscription_end", ""),
        client_data.get("region", ""),
        client_data.get("games", ""),
        client_data.get("reserve_photo", None)
    )
    add_client(data)
    clear_chat(message.chat.id)
    bot.send_message(message.chat.id, f"‚úÖ –ö–ª–∏–µ–Ω—Ç {client_data['username']} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!", reply_markup=main_menu)
    @bot.message_handler(func=lambda m: m.text == "üîç –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞")
def search_client(message):
    if message.from_user.id != admin_id:
        return
    msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ Telegram:")
    bot.register_next_step_handler(msg, show_client_data)

def show_client_data(message):
    clear_chat(message.chat.id)
    identifier = message.text.strip()
    client = get_client_by_identifier(identifier)
    if not client:
        return bot.send_message(message.chat.id, "–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")

    id_, username, birth, email, acc_pass, mail_pass, sub_name, sub_start, sub_end, region, games, reserve_file_id = client

    games_list = '\n‚Ä¢ ' + '\n‚Ä¢ '.join(games.split(' ‚Äî‚Äî ')) if games else '–ù–µ—Ç'
    text = f"""üë§ {username} | {birth}
üîê {acc_pass}
‚úâÔ∏è –ü–æ—á—Ç–∞-–ø–∞—Ä–æ–ª—å: {mail_pass}

üí≥ {sub_name}
üìÖ {sub_start} ‚Üí {sub_end}

üéÆ –ò–≥—Ä—ã:
{games_list}
"""

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("üì± –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä", "üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è")
    markup.add("üîê –ò–∑–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç", "üí≥ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É")
    markup.add("üéÆ –ò–∑–º–µ–Ω–∏—Ç—å –∏–≥—Ä—ã")
    markup.add("üóë –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞", "‚ùå –û—Ç–º–µ–Ω–∞")

    if reserve_file_id:
        bot.send_photo(message.chat.id, reserve_file_id, caption=text, reply_markup=markup)
    else:
        bot.send_message(message.chat.id, text, reply_markup=markup)

    client_data["id"] = id_

@bot.message_handler(func=lambda m: m.text.startswith("üì±") or m.text.startswith("üìÖ") or m.text.startswith("üîê") or m.text.startswith("üí≥") or m.text.startswith("üéÆ") or m.text.startswith("üóë") or m.text.startswith("‚ùå"))
def handle_edit_choice(message):
    if message.text == "üì± –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä":
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ Telegram:")
        bot.register_next_step_handler(msg, lambda m: update_field(m, "username"))
    elif message.text == "üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è":
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–¥.–º–º.–≥–≥–≥–≥):")
        bot.register_next_step_handler(msg, lambda m: update_field(m, "birth_date"))
    elif message.text == "üîê –ò–∑–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç":
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ:\nemail\n–ø–∞—Ä–æ–ª—å\n–ø–∞—Ä–æ–ª—å –æ—Ç –ø–æ—á—Ç—ã")
        bot.register_next_step_handler(msg, update_account_info)
    elif message.text == "üí≥ –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É":
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É (—Ç–µ–∫—Å—Ç–æ–º):")
        bot.register_next_step_handler(msg, lambda m: update_field(m, "subscription_name"))
    elif message.text == "üéÆ –ò–∑–º–µ–Ω–∏—Ç—å –∏–≥—Ä—ã":
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–≥—Ä (–ø–æ —Å—Ç—Ä–æ–∫–∞–º):")
        bot.register_next_step_handler(msg, update_games)
    elif message.text == "üóë –£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞":
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add("–î–∞", "–ù–µ—Ç")
        bot.send_message(message.chat.id, "–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?", reply_markup=markup)
        bot.register_next_step_handler(message, confirm_deletion)
    else:
        bot.send_message(message.chat.id, "–û—Ç–º–µ–Ω–∞", reply_markup=main_menu)

def update_field(message, field):
    update_client_field(client_data["id"], field, message.text.strip())
    bot.send_message(message.chat.id, "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ!", reply_markup=main_menu)

def update_account_info(message):
    lines = message.text.strip().split("\n")
    email = lines[0] if len(lines) > 0 else ""
    password = lines[1] if len(lines) > 1 else ""
    mail_pass = lines[2] if len(lines) > 2 else ""
    update_client_field(client_data["id"], "email", email)
    update_client_field(client_data["id"], "account_password", f"{email};{password}")
    update_client_field(client_data["id"], "mail_password", mail_pass)
    bot.send_message(message.chat.id, "‚úÖ –ê–∫–∫–∞—É–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω!", reply_markup=main_menu)

def update_games(message):
    games = message.text.strip().split("\n")
    joined = " ‚Äî‚Äî ".join(games)
    update_client_field(client_data["id"], "games", joined)
    bot.send_message(message.chat.id, "‚úÖ –ò–≥—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!", reply_markup=main_menu)

def confirm_deletion(message):
    if message.text == "–î–∞":
        delete_client_by_id(client_data["id"])
        bot.send_message(message.chat.id, "‚ùå –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω.", reply_markup=main_menu)
    else:
        bot.send_message(message.chat.id, "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=main_menu)

# –ó–∞–ø—É—Å–∫
if __name__ == "__main__":
    init_db()
    bot.infinity_polling()